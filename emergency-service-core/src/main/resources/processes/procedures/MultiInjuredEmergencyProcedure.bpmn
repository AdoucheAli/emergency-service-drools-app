<?xml version="1.0" encoding="UTF-8"?> 
<definitions id="Definition"
             targetNamespace="http://www.jboss.org/drools"
             typeLanguage="http://www.java.com/javaTypes"
             expressionLanguage="http://www.mvel.org/2.0"
             xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd"
             xmlns:g="http://www.jboss.org/drools/flow/gpd"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             xmlns:tns="http://www.jboss.org/drools">

  <itemDefinition id="_callItem" structureRef="com.wordpress.salaboy.model.Call" />
  <itemDefinition id="_emergencyItem" structureRef="com.wordpress.salaboy.model.Emergency" />
  <itemDefinition id="_emergency.vehiclesItem" structureRef="java.util.List" />
  <itemDefinition id="_emergency.severityItem" structureRef="Integer" />
  <itemDefinition id="_emergency.updatedNotesItem" structureRef="String" />
  <itemDefinition id="_patientPickUpEventItem" structureRef="com.wordpress.salaboy.model.events.VehicleHitsEmergencyEvent" />
  <itemDefinition id="_patientAtHospitalEventItem" structureRef="com.wordpress.salaboy.model.events.VehicleHitsEmergencyEvent" />

  <itemDefinition id="_12_multiInstanceItemType" />

  <process processType="Private" isExecutable="true" id="com.wordpress.salaboy.bpmn2.DefaultHeartAttackProcedure" name="Default Heart Attack Procedure" >

    <extensionElements>
     <tns:import name="com.wordpress.salaboy.model.Call" />
     <tns:import name="org.jbpm.workflow.instance.node.WorkItemNodeInstance" />
     <tns:import name="com.wordpress.salaboy.model.Emergency" />
     <tns:import name="com.wordpress.salaboy.model.Vehicle" />
     <tns:import name="com.wordpress.salaboy.model.VehicleUpdate" />
     <tns:import name="com.wordpress.salaboy.model.serviceclient.DistributedPeristenceServerService" />     
    </extensionElements>
    <!-- process variables -->
    <property id="call" itemSubjectRef="_callItem"/>
    <property id="emergency" itemSubjectRef="_emergencyItem"/>
    <property id="emergency.vehicles" itemSubjectRef="_emergency.vehiclesItem"/>
    <property id="emergency.severity" itemSubjectRef="_emergency.severityItem"/>
    <property id="emergency.updatedNotes" itemSubjectRef="_emergency.updatedNotesItem"/>
    <property id="patientPickUpEvent" itemSubjectRef="_patientPickUpEventItem"/>
    <property id="patientAtHospitalEvent" itemSubjectRef="_patientAtHospitalEventItem"/>
    <property id="patientAtHospitalEvent" itemSubjectRef="_patientAtHospitalEventItem"/>

    <!-- nodes -->
    <startEvent id="_1" name="StartProcess" />
    <userTask id="_2" name="Select Vehicle and Dispatch" >
      <ioSpecification>
        <dataInput id="_2_callInput" name="call" />
        <dataInput id="_2_emergencyInput" name="emergency" />
        <dataInput id="_2_CommentInput" name="Comment" />
        <dataInput id="_2_SkippableInput" name="Skippable" />
        <dataInput id="_2_TaskNameInput" name="TaskName" />
        <dataInput id="_2_PriorityInput" name="Priority" />
        <dataOutput id="_2_emergency.vehiclesOutput" name="emergency.vehicles" />
        <inputSet>
          <dataInputRefs>_2_callInput</dataInputRefs>
          <dataInputRefs>_2_emergencyInput</dataInputRefs>
          <dataInputRefs>_2_CommentInput</dataInputRefs>
          <dataInputRefs>_2_SkippableInput</dataInputRefs>
          <dataInputRefs>_2_TaskNameInput</dataInputRefs>
          <dataInputRefs>_2_PriorityInput</dataInputRefs>
        </inputSet>
        <outputSet>
          <dataOutputRefs>_2_emergency.vehiclesOutput</dataOutputRefs>
        </outputSet>
      </ioSpecification>
      <dataInputAssociation>
        <sourceRef>call</sourceRef>
        <targetRef>_2_callInput</targetRef>
      </dataInputAssociation>
      <dataInputAssociation>
        <sourceRef>emergency</sourceRef>
        <targetRef>_2_emergencyInput</targetRef>
      </dataInputAssociation>
      <dataInputAssociation>
        <targetRef>_2_CommentInput</targetRef>
        <assignment>
          <from xsi:type="tFormalExpression">en-UK</from>
          <to xsi:type="tFormalExpression">_2_CommentInput</to>
        </assignment>
      </dataInputAssociation>
      <dataInputAssociation>
        <targetRef>_2_SkippableInput</targetRef>
        <assignment>
          <from xsi:type="tFormalExpression">false</from>
          <to xsi:type="tFormalExpression">_2_SkippableInput</to>
        </assignment>
      </dataInputAssociation>
      <dataInputAssociation>
        <targetRef>_2_TaskNameInput</targetRef>
        <assignment>
          <from xsi:type="tFormalExpression"> Select Vehicle For #{call.id} </from>
          <to xsi:type="tFormalExpression">_2_TaskNameInput</to>
        </assignment>
      </dataInputAssociation>
      <dataInputAssociation>
        <targetRef>_2_PriorityInput</targetRef>
        <assignment>
          <from xsi:type="tFormalExpression"></from>
          <to xsi:type="tFormalExpression">_2_PriorityInput</to>
        </assignment>
      </dataInputAssociation>
      <dataOutputAssociation>
        <sourceRef>_2_emergency.vehiclesOutput</sourceRef>
        <targetRef>emergency.vehicles</targetRef>
      </dataOutputAssociation>
      <potentialOwner>
        <resourceAssignmentExpression>
          <formalExpression>garage_emergency_service</formalExpression>
        </resourceAssignmentExpression>
      </potentialOwner>
    </userTask>
    <endEvent id="_11" name="EndProcess" >
        <terminateEventDefinition/>
    </endEvent>
    <subProcess id="_12" name="Multiple Instances"  >
      <ioSpecification>
        <dataInput id="_12_input" name="MultiInstanceInput" />
        <inputSet/>
        <outputSet/>
      </ioSpecification>
      <dataInputAssociation>
        <sourceRef>emergency.vehicles</sourceRef>
        <targetRef>_12_input</targetRef>
      </dataInputAssociation>
      <multiInstanceLoopCharacteristics>
        <loopDataInputRef>_12_input</loopDataInputRef>
        <inputDataItem id="emergency.vehicle" itemSubjectRef="_12_multiInstanceItemType"/>
      </multiInstanceLoopCharacteristics>
    <!-- nodes -->
    <task id="_12-2-1" name="Dispatch Vehicle" tns:taskName="DispatchSelectedVehicles" >
      <ioSpecification>
        <dataInput id="_12-2-1_callInput" name="call" />
        <dataInput id="_12-2-1_emergency.vehicleInput" name="emergency.vehicle" />
        <inputSet>
          <dataInputRefs>_12-2-1_callInput</dataInputRefs>
          <dataInputRefs>_12-2-1_emergency.vehicleInput</dataInputRefs>
        </inputSet>
        <outputSet>
        </outputSet>
      </ioSpecification>
      <dataInputAssociation>
        <sourceRef>call</sourceRef>
        <targetRef>_12-2-1_callInput</targetRef>
      </dataInputAssociation>
      <dataInputAssociation>
        <sourceRef>emergency.vehicle</sourceRef>
        <targetRef>_12-2-1_emergency.vehicleInput</targetRef>
      </dataInputAssociation>
    </task>
    <parallelGateway id="_12-2-2" name="pickedUpGateway" gatewayDirection="Converging" />
    <intermediateCatchEvent id="_12-2-3" name="PickUpPatientEvent" >
      <dataOutput id="_12-2-3_Output" name="event" />
      <dataOutputAssociation>
      <sourceRef>_12-2-3_Output</sourceRef>
      <targetRef>patientPickUpEvent</targetRef>
      </dataOutputAssociation>
      <outputSet>
        <dataOutputRefs>_12-2-3_Output</dataOutputRefs>
      </outputSet>
      <signalEventDefinition signalRef="com.wordpress.salaboy.model.events.PatientPickUpEvent"/>
    </intermediateCatchEvent>
    <userTask id="_12-2-4" name="Update Situation" >
      <extensionElements>
        <tns:onEntry-script scriptFormat="http://www.java.com/java">
          <script>System.out.println("------On-entry"); System.out.println(((WorkItemNodeInstance)kcontext.getNodeInstance()).getWorkItem());</script>
        </tns:onEntry-script>
        <tns:onExit-script scriptFormat="http://www.java.com/java">
          <script>System.out.println("------On-exit");
          Emergency em =  (Emergency)((WorkItemNodeInstance)kcontext.getNodeInstance()).getWorkItem().getParameter("emergency");
          Vehicle vehicle =  (Vehicle)((WorkItemNodeInstance)kcontext.getNodeInstance()).getWorkItem().getParameter("vehicle");
          String comment = (String)((WorkItemNodeInstance)kcontext.getNodeInstance()).getWorkItem().getResult("comment");
          Integer priority = (Integer)((WorkItemNodeInstance)kcontext.getNodeInstance()).getWorkItem().getResult("priority");
          //em.addUpdate(vehicle.getId(), new VehicleUpdate(comment, priority));
          DistributedPeristenceServerService.getInstance().getAllEmergencies().iterator().next().addUpdate(vehicle.getId(), new VehicleUpdate(comment, priority));
          System.out.println("---" + em);
          System.out.println("---" + vehicle);
          System.out.println("---" + comment);
          System.out.println("---" + priority);
          </script>
        </tns:onExit-script>
      </extensionElements>

      <ioSpecification>      
        <dataInput id="_12-2-4_callInput" name="call" />
        <dataInput id="_12-2-4_emergencyInput" name="emergency" />
        <dataInput id="_12-2-4_vehicleInput" name="vehicle" />
        <dataInput id="_12-2-4_CommentInput" name="Comment" />
        <dataInput id="_12-2-4_SkippableInput" name="Skippable" />
        <dataInput id="_12-2-4_TaskNameInput" name="TaskName" />
        <dataInput id="_12-2-4_PriorityInput" name="Priority" />
        <dataOutput id="_12-2-4_commentOutput" name="comment" />
        <dataOutput id="_12-2-4_priorityOutput" name="priority" />
        <dataOutput id="_12-2-4_emergencyOutput" name="emergency" />
        <inputSet>
          <dataInputRefs>_12-2-4_callInput</dataInputRefs>
          <dataInputRefs>_12-2-4_emergencyInput</dataInputRefs>
          <dataInputRefs>_12-2-4_CommentInput</dataInputRefs>
          <dataInputRefs>_12-2-4_SkippableInput</dataInputRefs>
          <dataInputRefs>_12-2-4_TaskNameInput</dataInputRefs>
          <dataInputRefs>_12-2-4_PriorityInput</dataInputRefs>
          <dataInputRefs>_12-2-4_commentOutput</dataInputRefs>
          <dataInputRefs>_12-2-4_priorityOutput</dataInputRefs>
          <dataInputRefs>_12-2-4_vehicleInput</dataInputRefs>
        </inputSet>
        <outputSet>
          <dataOutputRefs>_12-2-4_emergencyOutput</dataOutputRefs>
        </outputSet>
      </ioSpecification>
      <dataInputAssociation>
        <sourceRef>emergency.vehicle</sourceRef>
        <targetRef>_12-2-4_vehicleInput</targetRef>
      </dataInputAssociation>
      <dataInputAssociation>
        <sourceRef>call</sourceRef>
        <targetRef>_12-2-4_callInput</targetRef>
      </dataInputAssociation>
      <dataInputAssociation>
        <sourceRef>emergency</sourceRef>
        <targetRef>_12-2-4_emergencyInput</targetRef>
      </dataInputAssociation>
      <dataInputAssociation>
        <targetRef>_12-2-4_CommentInput</targetRef>
        <assignment>
          <from xsi:type="tFormalExpression">en-UK</from>
          <to xsi:type="tFormalExpression">_12-2-4_CommentInput</to>
        </assignment>
      </dataInputAssociation>
      <dataInputAssociation>
        <targetRef>_12-2-4_SkippableInput</targetRef>
        <assignment>
          <from xsi:type="tFormalExpression">false</from>
          <to xsi:type="tFormalExpression">_12-2-4_SkippableInput</to>
        </assignment>
      </dataInputAssociation>
      <dataInputAssociation>
        <targetRef>_12-2-4_TaskNameInput</targetRef>
        <assignment>
          <from xsi:type="tFormalExpression"> Doctor's Update For Emergency: #{emergency.id} Phone Call( #{call.id} )</from>
          <to xsi:type="tFormalExpression">_12-2-4_TaskNameInput</to>
        </assignment>
      </dataInputAssociation>
      <dataInputAssociation>
        <targetRef>_12-2-4_PriorityInput</targetRef>
        <assignment>
          <from xsi:type="tFormalExpression"></from>
          <to xsi:type="tFormalExpression">_12-2-4_PriorityInput</to>
        </assignment>
      </dataInputAssociation>
      <dataOutputAssociation>
        <sourceRef>_12-2-4_emergencyOutput</sourceRef>
        <targetRef>emergency</targetRef>
      </dataOutputAssociation>
      <potentialOwner>
        <resourceAssignmentExpression>
          <formalExpression>doctor</formalExpression>
        </resourceAssignmentExpression>
      </potentialOwner>
    </userTask>
    <businessRuleTask id="_12-2-5" name="Select Hospital" g:ruleFlowGroup="hospital-selection" >
    </businessRuleTask>
    <intermediateCatchEvent id="_12-2-6" name="PatientAtHospitalEvent" >
      <dataOutput id="_12-2-6_Output" name="event" />
      <dataOutputAssociation>
      <sourceRef>_12-2-6_Output</sourceRef>
      <targetRef>patientAtHospitalEvent</targetRef>
      </dataOutputAssociation>
      <outputSet>
        <dataOutputRefs>_12-2-6_Output</dataOutputRefs>
      </outputSet>
      <signalEventDefinition signalRef="com.wordpress.salaboy.model.events.PatientAtHospitalEvent"/>
    </intermediateCatchEvent>
    <startEvent id="_12-2-7" name="StartMultiple" />
    <parallelGateway id="_12-2-8" name="atHospital" gatewayDirection="Converging" />
    <task id="_12-2-9" name="Local Report" tns:taskName="Report" >
      <ioSpecification>
        <dataInput id="_12-2-9_vehicleInput" name="vehicle" />
        <dataInput id="_12-2-9_emergencyInput" name="emergency" />
        <inputSet>
          <dataInputRefs>_12-2-9_vehicleInput</dataInputRefs>
          <dataInputRefs>_12-2-9_emergencyInput</dataInputRefs>
        </inputSet>
        <outputSet>
        </outputSet>
      </ioSpecification>
      <dataInputAssociation>
        <sourceRef>emergency.vehicle</sourceRef>
        <targetRef>_12-2-9_vehicleInput</targetRef>
      </dataInputAssociation>
      <dataInputAssociation>
        <sourceRef>emergency</sourceRef>
        <targetRef>_12-2-9_emergencyInput</targetRef>
      </dataInputAssociation>
    </task>
    <scriptTask id="_12-2-10" name="Stop Ambulance Tracking" scriptFormat="http://www.java.com/java" >
      <script>
        System.out.println(" &gt;&gt;&gt;&gt;&gt;&gt; Stopping Ambulance Tracking System -&gt; Report: ");
                System.out.println(" &gt;&gt;&gt;&gt;&gt;&gt; "+com.wordpress.salaboy.model.serviceclient
                                    .DistributedPeristenceServerService.getInstance()
                                        .getReportByCallId(((Call)kcontext.getVariable("call")).getId()).getReportString());
      </script>
    </scriptTask>
    <endEvent id="_12-2-11" name="EndMultiple" />
    <!-- connections -->
    <sequenceFlow id="_12-2-7-_12-2-1" sourceRef="_12-2-7" targetRef="_12-2-1" />
    <sequenceFlow id="_12-2-1-_12-2-2" sourceRef="_12-2-1" targetRef="_12-2-2" />
    <sequenceFlow id="_12-2-3-_12-2-2" sourceRef="_12-2-3" targetRef="_12-2-2" />
    <sequenceFlow id="_12-2-2-_12-2-4" sourceRef="_12-2-2" targetRef="_12-2-4" />
    <sequenceFlow id="_12-2-4-_12-2-5" sourceRef="_12-2-4" targetRef="_12-2-5" />
    <sequenceFlow id="_12-2-5-_12-2-8" sourceRef="_12-2-5" targetRef="_12-2-8" />
    <sequenceFlow id="_12-2-6-_12-2-8" sourceRef="_12-2-6" targetRef="_12-2-8" />
    <sequenceFlow id="_12-2-10-_12-2-9" sourceRef="_12-2-10" targetRef="_12-2-9" />
    <sequenceFlow id="_12-2-8-_12-2-10" sourceRef="_12-2-8" targetRef="_12-2-10" />
    <sequenceFlow id="_12-2-9-_12-2-11" sourceRef="_12-2-9" targetRef="_12-2-11" />
    </subProcess>
    <task id="_13" name="Global Report" tns:taskName="GlobalReport" >
      <ioSpecification>
        <inputSet>
        </inputSet>
        <outputSet>
        </outputSet>
      </ioSpecification>
    </task>

    <!-- connections -->
    <sequenceFlow id="_1-_2" sourceRef="_1" targetRef="_2" />
    <sequenceFlow id="_13-_11" sourceRef="_13" targetRef="_11" />
    <sequenceFlow id="_2-_12" sourceRef="_2" targetRef="_12" />
    <sequenceFlow id="_12-_13" sourceRef="_12" targetRef="_13" />

  </process>

  <bpmndi:BPMNDiagram>
    <bpmndi:BPMNPlane bpmnElement="com.wordpress.salaboy.bpmn2.DefaultHeartAttackProcedure" >
      <bpmndi:BPMNShape bpmnElement="_1" >
        <dc:Bounds x="16" y="16" width="48" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_2" >
        <dc:Bounds x="96" y="16" width="223" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_11" >
        <dc:Bounds x="554" y="408" width="48" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12" >
        <dc:Bounds x="28" y="108" width="1148" height="216" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-1" >
        <dc:Bounds x="112" y="149" width="163" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-2" >
        <dc:Bounds x="313" y="178" width="48" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-3" >
        <dc:Bounds x="159" y="232" width="48" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-4" >
        <dc:Bounds x="403" y="177" width="157" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-5" >
        <dc:Bounds x="628" y="173" width="107" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-6" >
        <dc:Bounds x="614" y="244" width="48" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-7" >
        <dc:Bounds x="32" y="163" width="48" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-8" >
        <dc:Bounds x="766" y="224" width="48" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-9" >
        <dc:Bounds x="862" y="241" width="121" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-10" >
        <dc:Bounds x="820" y="153" width="193" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_12-2-11" >
        <dc:Bounds x="1048" y="199" width="48" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_13" >
        <dc:Bounds x="435" y="352" width="168" height="48" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="_12-2-7-_12-2-1" >
        <di:waypoint x="28" y="79" />
        <di:waypoint x="165" y="65" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-2-1-_12-2-2" >
        <di:waypoint x="165" y="65" />
        <di:waypoint x="309" y="94" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-2-3-_12-2-2" >
        <di:waypoint x="155" y="148" />
        <di:waypoint x="309" y="94" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-2-2-_12-2-4" >
        <di:waypoint x="309" y="94" />
        <di:waypoint x="453" y="93" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-2-4-_12-2-5" >
        <di:waypoint x="453" y="93" />
        <di:waypoint x="653" y="89" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-2-5-_12-2-8" >
        <di:waypoint x="653" y="89" />
        <di:waypoint x="762" y="140" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-2-6-_12-2-8" >
        <di:waypoint x="610" y="160" />
        <di:waypoint x="762" y="140" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-2-10-_12-2-9" >
        <di:waypoint x="888" y="69" />
        <di:waypoint x="894" y="157" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-2-8-_12-2-10" >
        <di:waypoint x="762" y="140" />
        <di:waypoint x="888" y="69" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-2-9-_12-2-11" >
        <di:waypoint x="894" y="157" />
        <di:waypoint x="1044" y="115" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_1-_2" >
        <di:waypoint x="40" y="40" />
        <di:waypoint x="207" y="40" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_13-_11" >
        <di:waypoint x="519" y="376" />
        <di:waypoint x="578" y="432" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_2-_12" >
        <di:waypoint x="207" y="40" />
        <di:waypoint x="602" y="216" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12-_13" >
        <di:waypoint x="602" y="216" />
        <di:waypoint x="519" y="376" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</definitions>